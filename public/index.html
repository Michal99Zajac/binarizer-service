<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC Client</title>
  </head>
  <body>
    <h1>WebRTC Client</h1>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline></video>
    <button id="startButton">Start</button>
    <script>
      let pc = new RTCPeerConnection();

      pc.ontrack = function(event) {
        let remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            console.log('Received remote stream');
        }
      };

      pc.oniceconnectionstatechange = function(event) {
        console.log('ICE connection state change:', pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
          alert('Connection established.');
        }
      };

      document.getElementById('startButton').addEventListener('click', async function() {
        try {
          const stream = navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              frameRate: { ideal: 60 }
            },
            audio: false
          });

          stream.getTracks().forEach(function(track) {
            pc.addTrack(track, stream);
          });

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          const response = fetch('http://127.0.0.1:8000/offer', {
            method: 'POST',
            body: JSON.stringify({
              sdp: pc.localDescription.sdp,
              type: pc.localDescription.type
            }),
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const answer = await response.json();

          pc.setRemoteDescription(answer);
        } catch (e) {
          console.error(e);
        }
      });
    </script>
  </body>
</html>
